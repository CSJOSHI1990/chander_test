name: RDS Refresh

on:
  workflow_dispatch:
    inputs:
      operation:
        description: "Operation to perform (create|destroy)"
        required: true
        type: choice
        options:
          - plan
          - plan-delete
          - upgrade
          - delete
      system_name:
        description: "System or Datacenter"
        required: false
        type: choice
        options:
          - us06
          - us07
      force:
        description: Force apply
        type: boolean
        default: true
      job_tag:
        description: "Job Tag to run"
        required: false
        type: choice
        options:
          - refreshable # Refresh RDS instances using final snapshot
          - renewal # Fresh New RDS instance created without using any snapshot
  schedule:
    # us01
    - cron: "0 2 * * 6"   # Friday 9:00 PM EST -> delete us01
    - cron: "0 6 * * 1"   # Monday 1:00 AM EST -> upgrade us01
    # us02
    - cron: "0 3 * * 6"   # Friday 10:00 PM EST -> delete us02
    - cron: "0 4 * * 1"   # Sunday 11:00 PM EST -> upgrade us02
    # us02
    - cron: "26 5 * * 4"   # Friday 8:20 PM EST -> delete us02
    - cron: "28 5 * * 4"   # Sunday 8:30 PM EST -> upgrade us02
jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      system: ${{ steps.set-vars.outputs.system }}
      operation: ${{ steps.set-vars.outputs.operation }}
    steps:
      - name: Decide operation
        id: set-vars
        run: |
          if [ "${{ github.event_name }}" == "schedule" ]; then
            case "${{ github.event.schedule }}" in
              "0 2 * * 6")  echo "system=us01" >> $GITHUB_OUTPUT; echo "operation=delete"  >> $GITHUB_OUTPUT ;;
              "0 6 * * 1")  echo "system=us01" >> $GITHUB_OUTPUT; echo "operation=upgrade" >> $GITHUB_OUTPUT ;;
              "0 3 * * 6")  echo "system=us02" >> $GITHUB_OUTPUT; echo "operation=delete"  >> $GITHUB_OUTPUT ;;
              "0 4 * * 1")  echo "system=us02" >> $GITHUB_OUTPUT; echo "operation=upgrade" >> $GITHUB_OUTPUT ;;
              "26 5 * * 4")  echo "system=us02" >> $GITHUB_OUTPUT; echo "operation=delete"  >> $GITHUB_OUTPUT ;;
              "28 5 * * 4")  echo "system=us02" >> $GITHUB_OUTPUT; echo "operation=upgrade"  >> $GITHUB_OUTPUT ;;
            esac
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "system=${{ github.event.inputs.system_name }}" >> $GITHUB_OUTPUT
            echo "operation=${{ github.event.inputs.operation }}" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: RDS Refresh-${{ needs.setup.outputs.system }}-${{ needs.setup.outputs.operation }}
    permissions:
      id-token: write
      contents: read
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Print Command
        run: |
          echo "deploy ${{ needs.setup.outputs.operation }} -S ${{ needs.setup.outputs.system }} -Force ${{ github.event.inputs.force }}"
